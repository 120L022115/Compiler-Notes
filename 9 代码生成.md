#### 9 代码生成

1. 指令选择：选择适当的目标机指令来实现中间表示(IR)语句
   寄存器分配（allocation）和指派（assignment）：把哪个值放在哪个寄存器中
   指令排序：按照什么顺序来安排指令的执行

2. 一个简单的目标机模型

   1. 加载 LD、保存 ST、运算 OP、无条件跳转 BR、条件跳转 Bcond

   2. 用变量名表示地址

   3. 寻址模式：
      1. a(r)：基地址+偏移量

      2. c(r)：偏移常量+基地址

      3. *r：间接寻址

      4. *c(r)：

      5. #c：立即数

3. 指令选择

4. 内存分配

   1. 栈式分配
   2. 静态分配

5. 寄存器分配：以基本块为单位管理

   1. 函数：getReg(I)，I：x = y op z，为三地址指令I选择寄存器

   2. 寄存器描述符：记录了当前寄存器存放了**哪些**变量的值

   3. 地址描述符：记录运行时每个变量的当前值存放在**哪些**位置：寄存器、内存、栈等等。

   4. 基本块收尾处理：基本块出口活跃变量需要**存储于内存**，不能仅在寄存器中。

   5. 生成加载、保存指令时，必须同时更新寄存器和地址描述符。

      1. LD R,x ：修改寄存器R描述符，只包含x；修改x的地址描述符添加R，从其他地址描述符中删除R。
      2. OP Rx, Ry, Rz：修改Rx寄存器描述符只包含x，从其他中删除x；地址寄存器同上。
      3. ST x, R：修改x地址描述符，添加内存位置。
      4. 如有复制语句，可以不生成，直接修改寄存器描述符和地址描述符。

   6. getReg实现：

      ![9](E:\OneDrive - stu.hit.edu.cn\学习\编译系统\截图\9.png)

      ![9.1](E:\OneDrive - stu.hit.edu.cn\学习\编译系统\截图\9.1.png)

6. 窥孔优化

   1. 窥孔：一个滑动窗口，窥孔优化是指在优化的时候，检查目标指令的一个滑动窗口(即窥孔) ，并且只要有可能就在窥孔内用更快或更短的指令来替换窗口中的指令序列。
   2. 也可以在中间代码生成之后直接应用窥孔优化来提高中间表示形式的质量
   3. 冗余指令删除：
      1. 冗余加载和保存：基本块边缘，上面刚保存，下面就加载。如果下面有标号不能删除。
      2. 不可达指令：无条件跳转后到第一个有标号的指令中间都不可达。

   4. 控制流优化：连续跳转。如果跳过了中间的跳转，且中间跳转无用，则可删除。
   5. 代数优化：
      1. 恒等式：删除x=x+0, x=x*1
      2. 强度削弱：对2的幂次乘积或除法改为移位运算。

   6. 充分利用高效指令代替：如x=x+1换为 inc x;


